<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Horse Racing (Sprite Sheet)</title>
  <style>
    *{margin:0;padding:0;box-sizing:border-box}
    body{font-family:Arial,Helvetica,sans-serif;background:linear-gradient(#87CEEB,#98D98E);overflow:hidden}
    #gameCanvas{display:block;margin:20px auto;background:linear-gradient(#7CB342,#558B2F);border:5px solid #8B4513;box-shadow:0 10px 30px rgba(0,0,0,.3)}
    #ui{
      position:absolute;top:20px;left:20px;background:rgba(139,69,19,.92);
      color:#fff;padding:14px;border-radius:10px;min-width:300px;max-width:360px
    }
    .row{display:flex;gap:8px;align-items:center;margin:6px 0}
    .row label{min-width:64px;font-size:13px}
    .row input[type="text"], .row input[type="number"]{
      flex:1;border:none;border-radius:6px;padding:6px 8px;outline:none;font-size:13px
    }
    .row input[type="file"]{flex:1}
    .tiny{font-size:12px;opacity:.9}
    .horse-info{background:rgba(0,0,0,.25);padding:6px 8px;border-radius:6px;margin:6px 0}
    #controls{
      position:absolute;bottom:20px;left:50%;transform:translateX(-50%);
      background:rgba(139,69,19,.92);color:#fff;border-radius:10px;padding:14px 16px;
      display:flex;flex-wrap:wrap;gap:10px;justify-content:center;align-items:center
    }
    button{
      background:#4CAF50;color:#fff;border:none;border-radius:6px;padding:10px 18px;
      cursor:pointer;transition:.2s;font-size:15px
    }
    button:hover{background:#45a049;transform:scale(1.05)}
    button:disabled{background:#666;transform:none;cursor:not-allowed}
    #winner{
      position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);
      background:rgba(255,215,0,.96);padding:28px;border-radius:14px;font-weight:700;
      color:#8B4513;display:none;text-align:center;font-size:22px;box-shadow:0 0 40px rgba(255,215,0,.8)
    }
  </style>
</head>
<body>
  <canvas id="gameCanvas"></canvas>

  <div id="ui">
    <h3>üèá Sprite Horse Racing</h3>

    <div class="tiny" style="margin-bottom:8px">
      Use a PNG sprite sheet: one row, multiple frames side-by-side. Set the frame count below.
    </div>

    <div id="horseConfig"></div>

    <div class="row">
      <label>Frames</label>
      <input id="framesInput" type="number" min="2" max="32" value="8" />
    </div>
    <div class="row">
      <label>Scale</label>
      <input id="scaleInput" type="number" min="0.2" max="4" step="0.1" value="1.2" />
    </div>
    <div class="tiny">Tip: If the horse looks squished or tiny, adjust <b>Frames</b> and <b>Scale</b>.</div>

    <hr style="border:none;height:1px;background:rgba(255,255,255,.25);margin:10px 0">

    <div id="leaderboard"></div>
  </div>

  <div id="controls">
    <button id="startBtn">Start Race</button>
    <button id="resetBtn" disabled>Reset Race</button>
    <button id="shuffleBtn">Shuffle Lanes</button>
  </div>

  <div id="winner"></div>

  <script>
    // --- Canvas & world ---
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');
    canvas.width = 1000;
    canvas.height = 600;

    const laneGap = 100;
    const laneOffset = 100; // first lane Y
    const finishLine = 900;

    let raceActive = false;
    let raceFinished = false;

    // --- Horses (basic defaults) ---

const horses = [
  { name:'Thunder', lane:1, color:'#8B0000', x:50, y:laneOffset+0*laneGap,
    speed:0, step:0, animTime:0, sprite:null,
    stats:{ baseSpeed:3.4, stamina:0.75, sprint:1.10, variance:0.25, fatigue:0.35 } },
  { name:'Lightning', lane:2, color:'#FFD700', x:50, y:laneOffset+1*laneGap,
    speed:0, step:0, animTime:0, sprite:null,
    stats:{ baseSpeed:3.2, stamina:0.95, sprint:1.05, variance:0.18, fatigue:0.25 } },
  { name:'Storm', lane:3, color:'#4169E1', x:50, y:laneOffset+2*laneGap,
    speed:0, step:0, animTime:0, sprite:null,
    stats:{ baseSpeed:3.0, stamina:1.10, sprint:0.98, variance:0.15, fatigue:0.18 } },
  { name:'Blaze', lane:4, color:'#FF4500', x:50, y:laneOffset+3*laneGap,
    speed:0, step:0, animTime:0, sprite:null,
    stats:{ baseSpeed:3.6, stamina:0.70, sprint:1.15, variance:0.30, fatigue:0.40 } },
  { name:'Shadow', lane:5, color:'#2F4F4F', x:50, y:laneOffset+4*laneGap,
    speed:0, step:0, animTime:0, sprite:null,
    stats:{ baseSpeed:3.1, stamina:1.00, sprint:1.00, variance:0.20, fatigue:0.25 } },
];


    // --- Sprite settings (shared) ---
    const spriteConfig = {
      frames: 8,   // horizontal frames in the sheet
      scale: 1.2,  // drawing scale
      fps: 14      // base animation fps, modulated by speed
    };

    // --- UI: per-horse config & file upload ---
    const horseConfigEl = document.getElementById('horseConfig');

    function makeHorseRow(h) {
      const wrap = document.createElement('div');
      wrap.className = 'horse-info';

      wrap.innerHTML = `
        <div class="row">
          <label>Lane ${h.lane}</label>
          <input type="text" class="nm" value="${h.name}">
          <input type="text" class="hex" value="${h.color}" title="Color (used for fallback badge)">
        </div>
        <div class="row">
          <label>Sprite</label>
          <input type="file" class="file" accept="image/png,image/webp,image/jpeg">
        </div>
      `;


// Stats row (sliders/inputs)
const statsHtml = document.createElement('div');
statsHtml.innerHTML = `
  <div class="row"><label>Base</label>
    <input type="number" step="0.1" class="base" value="${h.stats.baseSpeed}">
    <label>Stam</label>
    <input type="number" step="0.05" class="stam" value="${h.stats.stamina}">
  </div>
  <div class="row"><label>Sprint</label>
    <input type="number" step="0.05" class="sprint" value="${h.stats.sprint}">
    <label>Var</label>
    <input type="number" step="0.05" class="var" value="${h.stats.variance}">
  </div>
  <div class="row"><label>Fatigue</label>
    <input type="number" step="0.05" class="fat" value="${h.stats.fatigue}">
  </div>
`;
wrap.appendChild(statsHtml);

// Wire the inputs
statsHtml.querySelector('.base').oninput   = e => h.stats.baseSpeed = +e.target.value || h.stats.baseSpeed;
statsHtml.querySelector('.stam').oninput   = e => h.stats.stamina   = +e.target.value || h.stats.stamina;
statsHtml.querySelector('.sprint').oninput = e => h.stats.sprint    = +e.target.value || h.stats.sprint;
statsHtml.querySelector('.var').oninput    = e => h.stats.variance  = +e.target.value || h.stats.variance;
statsHtml.querySelector('.fat').oninput    = e => h.stats.fatigue   = +e.target.value || h.stats.fatigue;


      // Wire name/color changes
      wrap.querySelector('.nm').onchange = e => { h.name = e.target.value.trim() || h.name; refreshLeaderboard(); };
      wrap.querySelector('.hex').onchange = e => { h.color = e.target.value.trim() || h.color; refreshLeaderboard(); };

      // File upload -> sprite image
      wrap.querySelector('.file').onchange = e => {
        const file = e.target.files[0];
        if (!file) return;
        const url = URL.createObjectURL(file);
        const img = new Image();
        img.onload = () => {
          // store sprite meta on horse
          h.sprite = { img, url };
        };
        img.src = url;
      };

      return wrap;
    }

    horses.forEach(h => horseConfigEl.appendChild(makeHorseRow(h)));

    // Shared controls
    const framesInput = document.getElementById('framesInput');
    const scaleInput  = document.getElementById('scaleInput');
    framesInput.oninput = () => { spriteConfig.frames = Math.max(2, Math.min(32, +framesInput.value||8)); };
    scaleInput.oninput  = () => { spriteConfig.scale  = Math.max(0.2, Math.min(4, +scaleInput.value||1.2)); };

    // --- Track ---
    function drawTrack() {
      // grass
      ctx.fillStyle = '#558B2F';
      ctx.fillRect(0,0,canvas.width,canvas.height);

      // dashed lane lines
      ctx.strokeStyle = 'white';
      ctx.lineWidth = 2;
      ctx.setLineDash([10,5]);
      for (let i=0; i<=5; i++) {
        ctx.beginPath();
        ctx.moveTo(0, laneOffset - laneGap/2 + i*laneGap);
        ctx.lineTo(canvas.width, laneOffset - laneGap/2 + i*laneGap);
        ctx.stroke();
      }
      ctx.setLineDash([]);

      // finish line
      ctx.fillStyle = '#FF0000';
      ctx.fillRect(finishLine, 0, 5, canvas.height);
      for (let i=0; i<canvas.height; i+=20) {
        ctx.fillStyle = (i/20)%2===0 ? 'white' : 'black';
        ctx.fillRect(finishLine+5, i, 15, 10);
        ctx.fillRect(finishLine+20, i+10, 15, 10);
      }
    }

    // --- Sprite drawing ---
    function drawHorseSprite(horse, dt) {
      const { frames, scale, fps } = spriteConfig;
      const hasSprite = horse.sprite && horse.sprite.img && horse.sprite.img.complete;

      if (!hasSprite) {
        // fallback: small badge + lane number (until a sprite is uploaded)
        ctx.save();
        ctx.translate(horse.x, horse.y);
        ctx.fillStyle = horse.color;
        ctx.beginPath(); ctx.arc(0,0,18,0,Math.PI*2); ctx.fill();
        ctx.fillStyle = '#fff'; ctx.font='bold 14px Arial'; ctx.textAlign='center'; ctx.textBaseline='middle';
        ctx.fillText(horse.lane, 0, 0);
        ctx.restore();
        return;
      }

      const img = horse.sprite.img;
      const frameW = Math.floor(img.width / frames);
      const frameH = img.height; // one row sheet

      // advance animation timer by speed-modulated fps
      // faster horses animate slightly faster (feel of stride rate)
      const animFps = fps + horse.speed * 0.6;
      horse.animTime = (horse.animTime || 0) + animFps * dt;
      const frameIndex = Math.floor(horse.animTime) % frames;

      const drawW = frameW * scale;
      const drawH = frameH * scale;

      ctx.save();
      ctx.translate(horse.x, horse.y);
      ctx.drawImage(
        img,
        frameIndex * frameW, 0, frameW, frameH,       // src rect
        -drawW*0.5, -drawH*0.5, drawW, drawH          // dst (centered)
      );

      // optional nameplate
      ctx.fillStyle = 'rgba(0,0,0,.5)';
      ctx.fillRect(-drawW*0.3, drawH*0.5-10, drawW*0.6, 18);
      ctx.fillStyle = '#fff';
      ctx.font = '12px Arial';
      ctx.textAlign = 'center';
      ctx.textBaseline = 'middle';
      ctx.fillText(horse.name, 0, drawH*0.5 - 1);
      ctx.restore();
    }

    // --- Leaderboard / UI ---
    const leaderboard = document.getElementById('leaderboard');
    function refreshLeaderboard() {
      const sorted = [...horses].sort((a,b) => b.x - a.x);
      leaderboard.innerHTML = sorted.map((h,i) => {
        const pct = Math.max(0, Math.round((h.x / finishLine) * 100));
        return `<div class="horse-info">${i+1}. <b>${h.name}</b> ‚Äî Lane ${h.lane} ‚Äî <span style="color:${h.color}">‚óè</span> ${pct}%</div>`;
      }).join('');
    }

    // --- Race control ---
    function startRace() {
      if (raceActive) return;
      raceActive = true; raceFinished = false;
      document.getElementById('startBtn').disabled = true;
      document.getElementById('resetBtn').disabled = true;
      document.getElementById('winner').style.display = 'none';
      lastTs = performance.now(); // reset timer
    }

    function resetRace() {
      raceActive = false; raceFinished = false;
      horses.forEach(h=>{
        h.x=50; h.speed=0; h.step=0; h.animTime=0;
        h.y = laneOffset + (h.lane-1)*laneGap;
      });
      document.getElementById('startBtn').disabled = false;
      document.getElementById('resetBtn').disabled = true;
      document.getElementById('winner').style.display = 'none';
      refreshLeaderboard();
    }

    function shuffleLanes() {
      const ids = [1,2,3,4,5].sort(()=>Math.random()-0.5);
      horses.forEach((h,i)=>{ h.lane = ids[i]; h.y = laneOffset + (h.lane-1)*laneGap; });
      refreshLeaderboard();
    }

    function showWinner(horse) {
      const el = document.getElementById('winner');
      el.innerHTML = `üèÜ ${horse.name} WINS! üèÜ<br/><br/>Lane ${horse.lane}`;
      el.style.display = 'block';
      document.getElementById('resetBtn').disabled = false;
      document.getElementById('startBtn').disabled = true;
    }

    // --- Physics / update ---
  function updateHorses(dt) {
  if (!raceActive || raceFinished) return;

  horses.forEach(h => {
    // distance progress 0..1
    const prog = Math.min(1, (h.x - 50) / (finishLine - 50));

    // components
    const startBoost = 1 + (h.stats.sprint - 1) * Math.exp(-prog * 6); // big at start, fades
    const staminaHold = Math.pow(h.stats.stamina, prog * 2.2);         // >1 holds speed later
    const tired = 1 - h.stats.fatigue * Math.max(0, prog - 0.5);       // fatigue after halfway
    const jitter = (Math.random() - 0.5) * h.stats.variance;           // randomness

    // final per-frame speed
    const s = h.stats.baseSpeed * startBoost * staminaHold * tired + jitter;

    h.speed = Math.max(0.8, s);         // keep it reasonable
    h.x += h.speed;
    h.step += h.speed * 0.08;

    if (h.x >= finishLine && !raceFinished) {
      raceFinished = true; raceActive = false; showWinner(h);
    }
  });

  refreshLeaderboard();
}


    // --- Game loop with proper dt ---
    let lastTs = performance.now();
    function loop(ts) {
      const dt = Math.min(0.05, (ts - lastTs) / 1000); // seconds, clamp to avoid big jumps
      lastTs = ts;

      drawTrack();
      horses.slice().sort((a,b)=>a.y-b.y).forEach(h => drawHorseSprite(h, dt));
      updateHorses(dt);

      requestAnimationFrame(loop);
    }

    // Buttons
    document.getElementById('startBtn').onclick = startRace;
    document.getElementById('resetBtn').onclick = resetRace;
    document.getElementById('shuffleBtn').onclick = shuffleLanes;

    // Init
    refreshLeaderboard();
    requestAnimationFrame(loop);
  </script>
</body>
</html>
